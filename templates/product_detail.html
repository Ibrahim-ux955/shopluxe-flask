{% extends 'base.html' %}

{% block content %}
<style>
  .product-card {
    border-radius: 16px;
    overflow: hidden;
    background: #fff;
    padding: 20px;
  }

  .main-img {
    width: 100%;
    height: 380px;
    object-fit: cover;
    border-radius: 14px;
    transition: opacity 0.3s ease;
  }

  .thumbs img {
    width: 60px;
    height: 60px;
    object-fit: cover;
    border-radius: 8px;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.2s ease;
  }

  .thumbs img.active {
    border-color: #198754;
  }

  .size-option,
  .color-option {
    display: inline-block;
    margin: 0 5px;
    cursor: pointer;
    border: 2px solid transparent;
    transition: all 0.2s ease;
  }

  .size-option.active,
  .color-option.active {
    border-color: #198754;
  }

  .size-option {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    background: #f8f9fa;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 600;
  }

  .color-option {
    width: 35px;
    height: 35px;
    border-radius: 50%;
  }

  .add-cart-btn {
    width: 100%;
    background-color: #198754;
    color: white;
    font-size: 1.2rem;
    border: none;
    border-radius: 10px;
    padding: 12px 0;
    transition: transform 0.2s ease, background 0.3s ease;
  }

  .add-cart-btn:hover {
    background-color: #157347;
    transform: scale(1.02);
  }

  .product-info h2 {
    font-weight: 700;
  }

  .related-item img {
    border-radius: 10px;
    object-fit: cover;
  }
</style>

<div class="container mt-5 mb-5">
  <div class="row justify-content-center">
    <div class="col-md-6">
      <div class="product-card shadow">

        <!-- ‚úÖ Image Container (makes heart button position correctly) -->
            <div class="position-relative">
  <!-- ‚úÖ Main Product Image -->
  <img id="mainImage"
       src="{{ url_for('static', filename='shoes/' + product.images[0]) }}"
       alt="{{ product.name }}"
       class="main-img mb-3">

      <!-- ‚ù§Ô∏è Wishlist Toggle Button -->
<button id="wishlistBtn"
        class="btn btn-light position-absolute top-0 end-0 m-3 rounded-circle shadow-sm"
        style="z-index: 10; width: 42px; height: 42px; display: flex; align-items: center; justify-content: center;"
        data-product-id="{{ product.id }}">
  
  {% set in_wishlist = false %}
  {% for p in session.get('wishlist', []) %}
    {% if p.id == product.id %}
      {% set in_wishlist = true %}
    {% endif %}
  {% endfor %}

  <i id="wishlistIcon" class="bi bi-heart{% if in_wishlist %}-fill text-danger{% endif %} fs-5"></i>
</button>
</div>

<!-- ‚úÖ AJAX Wishlist Script -->
<script>
document.addEventListener('DOMContentLoaded', () => {
  const btn = document.getElementById('wishlistBtn');
  const icon = document.getElementById('wishlistIcon');

  if (!btn) return; // Safety check

  btn.addEventListener('click', function(e) {
    e.preventDefault();
    const productId = this.getAttribute('data-product-id');

    fetch(`/toggle_wishlist_ajax/${productId}`, {
      method: 'POST',
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(response => response.json())
    .then(data => {
      if (data.success) {
        // Toggle the heart icon color instantly
        if (data.in_wishlist) {
          icon.classList.add('bi-heart-fill', 'text-danger');
          icon.classList.remove('bi-heart');
        } else {
          icon.classList.remove('bi-heart-fill', 'text-danger');
          icon.classList.add('bi-heart');
        }

        // üî¥ Update live navbar count
        updateWishlistCount();

        // üéâ Optional floating alert
        const alert = document.createElement('div');
        alert.className = 'position-fixed top-0 start-50 translate-middle-x alert alert-light border shadow-sm';
        alert.style.zIndex = 2000;
        alert.innerHTML = data.message;
        document.body.appendChild(alert);
        setTimeout(() => alert.remove(), 1500);
      }
    })
    .catch(err => console.error('Wishlist toggle error:', err));
  });
});

// ‚úÖ Global function to update wishlist count dynamically
function updateWishlistCount() {
  fetch('/wishlist_count')
    .then(res => res.json())
    .then(data => {
      const badge = document.getElementById('wishlist-count');
      if (badge) {
        badge.textContent = data.count > 0 ? data.count : '';
      }
    })
    .catch(err => console.error('Wishlist count update failed:', err));
}
</script>

<!-- ‚úÖ Optional subtle bounce animation -->
<style>
@keyframes pop {
  0% { transform: scale(1); }
  50% { transform: scale(1.3); }
  100% { transform: scale(1); }
}
.bi-heart-fill {
  animation: pop 0.2s ease-in-out;
}
</style>




        <!-- ‚úÖ Thumbnails -->
        <div class="thumbs d-flex justify-content-center gap-2 mb-3">
          {% for img in product.images %}
          <img src="{{ url_for('static', filename='shoes/' + img) }}" alt="thumb" class="thumb-img">
          {% endfor %}
        </div>

        <!-- ‚úÖ Product Info -->
        <div class="product-info text-center">
          <h2 class="mb-1">{{ product.name }}</h2>

          {% if product.on_sale and product.sale_price %}
          <p class="mb-1 text-muted text-decoration-line-through fs-5">GH‚Çµ {{ product.price }}</p>
          <p class="text-danger fw-bold fs-4">GH‚Çµ {{ product.sale_price }}</p>
          {% else %}
          <p class="text-success fw-bold fs-4">GH‚Çµ {{ product.price }}</p>
          {% endif %}

          {% if product.description %}
          <p class="text-muted">{{ product.description }}</p>
          {% endif %}
        </div>

        <!-- ‚úÖ Sizes -->
        {% if product.sizes %}
        <div class="text-center mt-3">
          <h6 class="fw-bold">Size</h6>
          <div>
            {% for size in product.sizes %}
            <span class="size-option {% if loop.first %}active{% endif %}">{{ size }}</span>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        <!-- ‚úÖ Colors -->
        {% if product.colors %}
        <div class="text-center mt-3">
          <h6 class="fw-bold">Color</h6>
          <div>
            {% for color in product.colors %}
            <span class="color-option {% if loop.first %}active{% endif %}" 
                  style="background: {{ color | lower }};" 
                  title="{{ color }}"></span>
            {% endfor %}
          </div>
        </div>
        {% endif %}

        <!-- ‚úÖ Add to Cart -->
        {% if product.stock is defined %}
        {% if product.stock > 0 %}
        <form action="{{ url_for('add_to_cart', index=product.index) }}" method="POST" class="mt-4">
          <input type="hidden" name="quantity" value="1">
          <button type="submit" class="add-cart-btn">
            üõí Add to Cart
          </button>
        </form>
        {% else %}
        <p class="text-danger text-center mt-3">Out of Stock</p>
        {% endif %}
        {% endif %}
      </div>
    </div>
  </div>

  <!-- ‚úÖ Related Products -->
  <hr class="my-5">
  <h4 class="text-center mb-4">üõçÔ∏è Related Products</h4>
  <div class="row justify-content-center">
    {% if related %}
    {% for item in related %}
    <div class="col-6 col-md-4 col-lg-3 mb-4 text-center">
      <a href="{{ url_for('product_detail', product_id=item.id) }}" class="text-decoration-none text-dark">
        <div class="card border-0 shadow-sm h-100 related-item">
          <img src="{{ url_for('static', filename='shoes/' + item.images[0]) }}" alt="{{ item.name }}"
            style="width: 100%; aspect-ratio: 1/1;">
          <div class="p-2">
            <p class="fw-semibold mb-1" style="font-size: 15px;">{{ item.name }}</p>
            {% if item.on_sale and item.sale_price %}
            <p class="mb-0">
              <span class="text-muted text-decoration-line-through small">GH‚Çµ {{ item.price }}</span><br>
              <span class="text-danger fw-bold">GH‚Çµ {{ item.sale_price }}</span>
            </p>
            {% else %}
            <p class="text-success fw-bold mb-0">GH‚Çµ {{ item.price }}</p>
            {% endif %}
          </div>
        </div>
      </a>
    </div>
    {% endfor %}
    {% else %}
    <p class="text-center text-muted">No related products found.</p>
    {% endif %}
  </div>
</div>

<!-- ‚úÖ JS for thumbnail and selection -->
<script>
  const mainImage = document.getElementById('mainImage');
  const thumbs = document.querySelectorAll('.thumb-img');
  thumbs.forEach(thumb => {
    thumb.addEventListener('click', function () {
      mainImage.style.opacity = 0;
      setTimeout(() => {
        mainImage.src = this.src;
        mainImage.style.opacity = 1;
      }, 150);
      thumbs.forEach(t => t.classList.remove('active'));
      this.classList.add('active');
    });
  });
  if (thumbs.length > 0) thumbs[0].classList.add('active');

  document.querySelectorAll('.size-option').forEach(el => {
    el.addEventListener('click', () => {
      document.querySelectorAll('.size-option').forEach(e => e.classList.remove('active'));
      el.classList.add('active');
    });
  });

  document.querySelectorAll('.color-option').forEach(el => {
    el.addEventListener('click', () => {
      document.querySelectorAll('.color-option').forEach(e => e.classList.remove('active'));
      el.classList.add('active');
    });
  });
</script>
{% endblock %}
