{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">

  <!-- Admin Navigation Buttons -->
  <div class="d-flex justify-content-center gap-2 mb-4 flex-wrap">
    <button class="btn btn-primary" id="btn-add">‚ûï Add New Product</button>
    <button class="btn btn-secondary" id="btn-all">üì¶ All Products</button>
    <button class="btn btn-success" id="btn-orders">üßæ All Orders</button>
    <button class="btn btn-info" id="btn-history">üìú Order History</button>
  </div>

  <!-- Add New Product Section -->
  <div id="section-add" class="admin-section">
    <div class="card shadow-lg border-0 mb-5" style="max-width: 700px; margin: 0 auto;">
      <div class="card-body">
        <h3 class="card-title text-center mb-4">Add New Product</h3>

        {% with messages = get_flashed_messages() %}
          {% if messages %}
            {% for message in messages %}
              <div class="alert alert-warning text-center">{{ message }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <form method="POST" enctype="multipart/form-data">
          <div class="mb-3">
            <label class="form-label" for="name">Product Name</label>
            <input type="text" name="name" id="name" class="form-control" required>
          </div>

          <div class="mb-3">
            <label class="form-label" for="price">Price</label>
            <input type="text" name="price" id="price" class="form-control" required>
          </div>

          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="on_sale" name="on_sale">
            <label class="form-check-label" for="on_sale">On Sale?</label>
          </div>

          <div class="mb-3">
            <label class="form-label" for="sale_price">Sale Price</label>
            <input type="number" step="0.01" class="form-control" id="sale_price" name="sale_price" placeholder="Enter sale price if applicable">
          </div>

          <div class="form-check mb-3">
            <input class="form-check-input" type="checkbox" id="featured" name="featured">
            <label class="form-check-label" for="featured">Feature this product on homepage carousel?</label>
          </div>

          <div class="mb-3">
            <label class="form-label" for="category">Category</label>
            <input type="text" name="category" id="category" class="form-control">
          </div>

          <div class="mb-3">
            <label class="form-label" for="description">Description</label>
            <textarea name="description" id="description" class="form-control" rows="3"></textarea>
          </div>

          <div class="mb-3">
            <label class="form-label" for="stock">Stock Count</label>
            <input type="number" name="stock" id="stock" class="form-control" min="0" required>
          </div>

          <div class="mb-3">
            <label class="form-label" for="sizes">Available Sizes</label>
            <input type="text" name="sizes" id="sizes" class="form-control" placeholder="e.g. 39, 40, 41, 42, 43">
            <small class="text-muted">Separate multiple sizes with commas.</small>
          </div>

          <div class="mb-3">
            <label class="form-label" for="colors">Available Colors</label>
            <input type="text" name="colors" id="colors" class="form-control" placeholder="e.g. Red, Blue, Black">
            <small class="text-muted">Separate multiple colors with commas.</small>
          </div>

          <div class="mb-3">
            <label class="form-label" for="images">Upload Images</label>
            <input type="file" name="images" id="images" class="form-control" multiple required>
          </div>

          <button type="submit" class="btn btn-primary w-100">Add Product</button>
        </form>
      </div>
    </div>
  </div>

  <!-- All Products Section -->
  <div id="section-all" class="admin-section" style="display:none;">
    <h4 class="mb-3">All Products</h4>
    <div class="row g-3">
      {% for p in products %}
      <div class="col-6 col-md-4 col-lg-3">
        <div class="card h-100 shadow-sm border-0">
          {% if p.images %}
            <img src="{{ url_for('static', filename='shoes/' + p.images[0]) }}" class="card-img-top" alt="{{ p.name }}" style="object-fit: cover; height: 180px;">
          {% elif p.image %}
            <img src="{{ url_for('static', filename='shoes/' + p.image) }}" class="card-img-top" alt="{{ p.name }}" style="object-fit: cover; height: 180px;">
          {% else %}
            <img src="{{ url_for('static', filename='shoes/placeholder.jpg') }}" class="card-img-top" alt="No image" style="object-fit: cover; height: 180px;">
          {% endif %}

          <div class="card-body p-2 d-flex flex-column">
            <h6 class="card-title text-truncate mb-1">{{ p.name }}</h6>
            <p class="card-text mb-2 small">
              {% if p.on_sale %}
                <span class="text-muted text-decoration-line-through">GH‚Çµ {{ p.price }}</span>
                <span class="fw-bold text-danger ms-1">GH‚Çµ {{ p.sale_price }}</span>
              {% else %}
                GH‚Çµ {{ p.price }}
              {% endif %}
            </p>

            <a href="{{ url_for('edit_product', product_id=p.id) }}" class="btn btn-warning btn-sm mb-1 w-100">‚úèÔ∏è Edit</a>
            <form method="POST" action="{{ url_for('delete', index=loop.index0) }}">
              <button type="submit" class="btn btn-danger btn-sm w-100">üóë Delete</button>
            </form>
          </div>
        </div>
      </div>
      {% endfor %}
    </div>
  </div>

    <!-- üßæ Orders Section -->
<div id="section-orders" class="admin-section" style="display:none;">
  <h4 class="mb-3">All Orders</h4>

  <!-- üîç Search Bar -->
  <div class="mb-3">
    <input type="text" id="search-orders" class="form-control" placeholder="Search by Order ID or Customer Name..." />
  </div>

  <div class="table-responsive">
    <table class="table table-bordered align-middle" id="orders-table">
      <thead class="table-light">
        <tr>
          <th>Order ID</th>
          <th>Customer / Products</th>
          <th>Total (GH‚Çµ)</th>
          <th>Status</th>
          <th>Time</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for o in orders | selectattr("status", "in", ["Pending", "Processing"]) | sort(attribute="local_time", reverse=True) %}
        <tr>
          <!-- üßæ Order ID -->
          <td><strong>{{ o.id }}</strong></td>

          <!-- üë§ Customer + üõçÔ∏è Products -->
          <td>
            <div><strong>{{ o.name }}</strong></div>
            <ul class="mb-0 small text-muted ps-3">
              {% for item in o.products %}
                <li>{{ item.name }} <span class="text-secondary">(x{{ item.quantity or 1 }})</span></li>
              {% endfor %}
            </ul>
          </td>

          <!-- üí∞ Total -->
          <td>GH‚Çµ {{ o.total }}</td>

          <!-- üö¶ Status -->
          <td>
            {% if o.status == "Pending" %}
              <span class="badge bg-warning text-dark">Pending</span>
            {% elif o.status == "Processing" %}
              <span class="badge bg-info text-dark">Processing</span>
            {% endif %}
          </td>

          <!-- üïí Time -->
          <td>{{ o.local_time }}</td>

          <!-- ‚öôÔ∏è Actions -->
          <td>
            <div class="d-flex flex-column flex-md-row gap-2">
              <form method="POST" action="{{ url_for('mark_delivered', order_id=o.id) }}">
                <button type="submit" class="btn btn-sm btn-success w-100">Delivered ‚úÖ</button>
              </form>
              <form method="POST" action="{{ url_for('cancel_order', order_id=o.id) }}">
                <button type="submit" class="btn btn-sm btn-danger w-100">Cancel ‚ùå</button>
              </form>
              <button class="btn btn-sm btn-secondary w-100" type="button" data-bs-toggle="collapse" data-bs-target="#details-{{ o.id }}">
                Details üìÑ
              </button>
            </div>
          </td>
        </tr>

        <!-- üìÑ Collapsible Details Row -->
        <tr class="collapse" id="details-{{ o.id }}">
          <td colspan="6">
            <div class="p-2 bg-light border rounded">
              <h6 class="fw-bold mb-2">Order Details</h6>
              <table class="table table-sm table-bordered mb-0">
                <thead class="table-secondary">
                  <tr>
                    <th>Product Name</th>
                    <th>Price (GH‚Çµ)</th>
                    <th>Quantity</th>
                    <th>Color</th>
                    <th>Size</th>
                  </tr>
                </thead>
                <tbody>
                  {% for item in o.products %}
                  <tr>
                    <td>{{ item.name }}</td>
                    <td>{{ item.price }}</td>
                    <td>{{ item.quantity or 1 }}</td>
                    <td>{{ item.color or '-' }}</td>
                    <td>{{ item.size or '-' }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
 
 <!-- üïì Order History Section -->
<div id="section-history" class="admin-section" style="display:none;">
  <h4 class="mb-3">Order History</h4>

  <!-- üîç Search Bar -->
  <div class="mb-3">
    <input type="text" id="search-history" class="form-control" placeholder="Search by Order ID or Customer Name..." />
  </div>

  <div class="table-responsive">
    <table class="table table-bordered align-middle" id="history-table">
      <thead class="table-light">
        <tr>
          <th>Order ID</th>
          <th>Customer / Products</th>
          <th>Total (GH‚Çµ)</th>
          <th>Status</th>
          <th>Completed Time</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
  {% for o in orders 
       | selectattr("status", "in", ["Delivered", "Cancelled"]) 
       | sort(attribute="completed_time", reverse=True) %}
  <tr>
    <!-- üßæ Order ID -->
    <td><strong>{{ o.id }}</strong></td>

    <!-- üë§ Customer + üõçÔ∏è Products -->
    <td>
      <div><strong>{{ o.name }}</strong></div>
      <ul class="mb-0 small text-muted ps-3">
        {% for item in o.products %}
          <li>{{ item.name }} <span class="text-secondary">(x{{ item.quantity or 1 }})</span></li>
        {% endfor %}
      </ul>
    </td>

    <!-- üí∞ Total -->
    <td>GH‚Çµ {{ o.total }}</td>

    <!-- üö¶ Status -->
    <td>
      {% if o.status == "Delivered" %}
        <span class="badge bg-success">Delivered</span>
      {% elif o.status == "Cancelled" %}
        <span class="badge bg-danger">Cancelled</span>
      {% endif %}
    </td>

    <!-- üïí Completed Time -->
    <td>{{ o.completed_time }}</td>

    <!-- ‚öôÔ∏è Actions -->
    <td>
      <button class="btn btn-sm btn-secondary w-100" type="button"
              data-bs-toggle="collapse" data-bs-target="#history-details-{{ o.id }}">
        Details üìÑ
      </button>
    </td>
  </tr>

  <!-- üìÑ Collapsible Details Row -->
  <tr class="collapse" id="history-details-{{ o.id }}">
    <td colspan="6">
      <div class="p-2 bg-light border rounded">
        <h6 class="fw-bold mb-2">Order Details</h6>
        <table class="table table-sm table-bordered mb-0">
          <thead class="table-secondary">
            <tr>
              <th>Product Name</th>
              <th>Price (GH‚Çµ)</th>
              <th>Quantity</th>
              <th>Color</th>
              <th>Size</th>
            </tr>
          </thead>
          <tbody>
            {% for item in o.products %}
            <tr>
              <td>{{ item.name }}</td>
              <td>{{ item.price }}</td>
              <td>{{ item.quantity or 1 }}</td>
              <td>{{ item.color or '-' }}</td>
              <td>{{ item.size or '-' }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </td>
  </tr>
  {% endfor %}
</tbody>
</table>
  </div>
</div>
 

<!-- üß† JS: Toggle + Search -->
<script>
  const btnAdd = document.getElementById('btn-add');
  const btnAll = document.getElementById('btn-all');
  const btnOrders = document.getElementById('btn-orders');
  const btnHistory = document.getElementById('btn-history');
  const sectionAdd = document.getElementById('section-add');
  const sectionAll = document.getElementById('section-all');
  const sectionOrders = document.getElementById('section-orders');
  const sectionHistory = document.getElementById('section-history');

  // Section Toggle
  btnAdd.addEventListener('click', () => {
    sectionAdd.style.display = 'block';
    sectionAll.style.display = 'none';
    sectionOrders.style.display = 'none';
    sectionHistory.style.display = 'none';
  });
  btnAll.addEventListener('click', () => {
    sectionAdd.style.display = 'none';
    sectionAll.style.display = 'block';
    sectionOrders.style.display = 'none';
    sectionHistory.style.display = 'none';
  });
  btnOrders.addEventListener('click', () => {
    sectionAdd.style.display = 'none';
    sectionAll.style.display = 'none';
    sectionOrders.style.display = 'block';
    sectionHistory.style.display = 'none';
  });
  btnHistory.addEventListener('click', () => {
    sectionAdd.style.display = 'none';
    sectionAll.style.display = 'none';
    sectionOrders.style.display = 'none';
    sectionHistory.style.display = 'block';
  });

  // üîç Live Search (Order ID + Customer)
  function setupSearch(inputId, tableId) {
    const input = document.getElementById(inputId);
    const table = document.getElementById(tableId);
    input.addEventListener('keyup', () => {
      const filter = input.value.toLowerCase();
      const rows = table.querySelectorAll('tbody tr:not(.collapse)');
      rows.forEach(row => {
        const text = row.textContent.toLowerCase();
        row.style.display = text.includes(filter) ? '' : 'none';
      });
    });
  }
  setupSearch('search-orders', 'orders-table');
  setupSearch('search-history', 'history-table');
</script>
</body>
</html>
{% endblock %}
